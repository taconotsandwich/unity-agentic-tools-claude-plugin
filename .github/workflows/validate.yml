name: Validate Plugin

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Validate JSON syntax
        run: |
          jq empty .claude-plugin/marketplace.json
          jq empty plugins/unity-agentic-tools/.claude-plugin/plugin.json
          jq empty plugins/unity-agentic-tools/hooks/hooks.json
          echo "All JSON files are valid"

      - name: Check required fields in plugin.json
        run: |
          NAME=$(jq -r '.name' plugins/unity-agentic-tools/.claude-plugin/plugin.json)
          VERSION=$(jq -r '.version' plugins/unity-agentic-tools/.claude-plugin/plugin.json)
          if [ "$NAME" = "null" ] || [ -z "$NAME" ]; then
            echo "ERROR: plugin.json missing 'name' field"
            exit 1
          fi
          if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
            echo "ERROR: plugin.json missing 'version' field"
            exit 1
          fi
          echo "plugin.json: name=$NAME version=$VERSION"

      - name: Verify hook scripts exist
        run: |
          MISSING=0
          for script in plugins/unity-agentic-tools/hooks/auto_setup.js plugins/unity-agentic-tools/hooks/detect_unity.js plugins/unity-agentic-tools/hooks/pre_unity_validate.js plugins/unity-agentic-tools/hooks/post_unity_verify.js plugins/unity-agentic-tools/hooks/unity_context_inject.js plugins/unity-agentic-tools/hooks/unity_docs_index.js; do
            if [ ! -f "$script" ]; then
              echo "ERROR: Missing hook script: $script"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then
            exit 1
          fi
          echo "All hook scripts present"

      - name: Validate plugin with Claude Code CLI (optional)
        continue-on-error: true
        run: |
          npm install -g @anthropic-ai/claude-code 2>/dev/null || true
          if command -v claude &> /dev/null; then
            claude plugin validate .
          else
            echo "Claude Code CLI not available, skipping plugin validation"
          fi
